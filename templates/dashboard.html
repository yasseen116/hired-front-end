{% extends "_base.html" %}

{% block title %}Provider Dashboard - Hired{% endblock %}

{% block content %}
<div id="dashboard-app" class="page">
    <div class="container" style="margin-top: 40px; margin-bottom: 60px;">

        <div v-if="loading" class="loading-state">
            <div class="spinner-border text-primary" role="status"></div>
            <p>Loading dashboard...</p>
        </div>

        <div v-else class="profile-layout">

            <aside class="profile-sidebar">
                <div class="content-card user-card">
                    <div class="member-avatar" style="background: #e0f2fe; border: 2px solid #bae6fd; display: flex; align-items: center; justify-content: center; overflow: hidden;">

                        <img v-if="user.photo" :src="user.photo" alt="Company Logo" style="width: 100%; height: 100%; object-fit: cover;">

                        <svg v-else xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#0a66c2" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 21h18"/>
                            <path d="M5 21V7l8-4 8 4v14"/>
                            <path d="M13 21V7"/>
                            <path d="M9 10a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
                            <path d="M9 14a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
                            <path d="M17 10a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
                            <path d="M17 14a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
                        </svg>

                    </div>
                    <h2 class="user-name">[[ user.company || 'My Company' ]]</h2>
                    <p class="user-title">[[ user.name ]]</p>
                    <p class="user-email">[[ user.email ]]</p>

                    <hr class="divider">

                    <nav class="dashboard-nav">
                        <button class="dash-nav-btn" :class="{ active: activeTab === 'post' }" @click="activeTab = 'post'">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                            Post a Job
                        </button>
                        <button class="dash-nav-btn" :class="{ active: activeTab === 'manage' }" @click="activeTab = 'manage'">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
                            Manage Jobs
                        </button>
                        <button class="dash-nav-btn" :class="{ active: activeTab === 'applications' }" @click="activeTab = 'applications'">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                            Applications
                            <span class="badge" v-if="pendingAppsCount > 0">[[ pendingAppsCount ]]</span>
                        </button>
                    </nav>
                </div>
            </aside>

            <main class="profile-content">

                <transition name="tab-fade" mode="out-in">

                    <div v-if="activeTab === 'post'" key="post">
                        <div class="content-card">
                            <div class="dashboard-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <h1>[[ isEditing ? 'Edit Job Posting' : 'Post a New Job' ]]</h1>
                                    <p style="color: #666;">[[ isEditing ? 'Update job details and requirements.' : 'Create a new opportunity and find the perfect talent.' ]]</p>
                                </div>
                                <button v-if="isEditing" @click="cancelEdit" class="btn btn-card-details" style="border-color: #ef4444; color: #ef4444;">Cancel Edit</button>
                            </div>

                            <div class="dashboard-tabs">
                                <button class="tab-btn" :class="{ active: uploadMode === 'url' }" @click="uploadMode = 'url'">Link Logo URL</button>
                                <button class="tab-btn" :class="{ active: uploadMode === 'file' }" @click="uploadMode = 'file'">Upload Logo Image</button>
                            </div>

                            <form @submit.prevent="submitJob" class="profile-form">
                                <div class="form-row">
                                    <div class="form-group half">
                                        <label>Job Title</label>
                                        <input type="text" v-model="form.title" placeholder="e.g. Senior Software Engineer" required>
                                    </div>
                                    <div class="form-group half">
                                        <label>Company Name</label>
                                        <input type="text" v-model="form.company" readonly style="background-color: #f1f5f9; cursor: not-allowed;">
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group half">
                                        <label>Location</label>
                                        <input type="text" v-model="form.location" placeholder="e.g. Cairo, Egypt" required>
                                    </div>
                                    <div class="form-group half">
                                        <label>Job Category</label>
                                        <div class="custom-select-wrapper" :class="{ open: categoryOpen }">
                                            <div class="custom-select-trigger" @click="toggleCategory">
                                                <span>[[ form.category || 'Select Category' ]]</span>
                                                <svg class="arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                                            </div>
                                            <div class="custom-options">
                                                <div class="custom-option" v-for="cat in categories" :key="cat" :class="{ selected: form.category === cat }" @click="selectCategory(cat)">[[ cat ]]</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group half">
                                        <label>Job Type</label>
                                        <div class="custom-select-wrapper" :class="{ open: typeOpen }">
                                            <div class="custom-select-trigger" @click="toggleType">
                                                <span>[[ form.type ]]</span>
                                                <svg class="arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                                            </div>
                                            <div class="custom-options">
                                                <div class="custom-option" v-for="t in jobTypes" :key="t" :class="{ selected: form.type === t }" @click="selectType(t)">[[ t ]]</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group half">
                                        <label>Salary</label>
                                        <input type="text" v-model="form.salary" placeholder="e.g. EGP 15,000" required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Experience Needed</label>
                                    <input type="text" v-model="form.experience" placeholder="e.g. 3-5 Years" required>
                                </div>

                                <div class="form-group" style="background: #f0f9ff; padding: 20px; border-radius: 8px; border: 1px dashed var(--primary-color);">
                                    <transition name="content-fade" mode="out-in">
                                        <div v-if="uploadMode === 'url'" key="url">
                                            <label>Company Logo URL</label>
                                            <input type="text" v-model="form.logo_url" placeholder="https://example.com/logo.png">
                                            <p class="helper-text">Enter a direct link to the image file.</p>
                                        </div>
                                        <div v-else key="file">
                                            <label>Upload Logo File</label>
                                            <div class="modal-upload-label" style="margin-bottom: 0;">
                                                <input type="file" id="logoUpload" @change="handleFileUpload" accept="image/*" style="display: none;">
                                                <label for="logoUpload" class="custom-file-upload" :class="{ 'has-file': logoFile }">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                                                    <span>[[ logoFile ? logoFile.name : 'Choose Image...' ]]</span>
                                                </label>
                                            </div>
                                            <p class="helper-text">Supported formats: PNG, JPG, JPEG.</p>
                                        </div>
                                    </transition>
                                </div>

                                <div class="form-group"><label>Job Description</label><textarea v-model="raw.description" rows="4" placeholder="Describe the role... (Put each point on a new line)"></textarea></div>
                                <div class="form-group"><label>Key Responsibilities</label><textarea v-model="raw.responsibilities" rows="4" placeholder="Responsibility 1&#10;Responsibility 2&#10;(Put each on a new line)"></textarea></div>
                                <div class="form-group"><label>Qualifications / Requirements</label><textarea v-model="raw.qualifications" rows="4" placeholder="Degree...&#10;Skills...&#10;(Put each on a new line)"></textarea></div>
                                <div class="form-group"><label>Soft Skills</label><textarea v-model="raw.soft_skills" rows="4" placeholder="Communication&#10;Leadership&#10;Teamwork&#10;(Put each skill on a new line)"></textarea></div>

                                <div style="margin-top: 30px;">
                                    <button type="submit" class="btn btn-login-action" :class="{ 'btn-loading': isSubmitting }">
                                        [[ isSubmitting ? 'Saving...' : (isEditing ? 'Update Job' : 'Post Job Now') ]]
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div v-if="activeTab === 'manage'" key="manage">
                        <div class="content-card">
                            <div class="dashboard-header">
                                <h1>Manage Jobs</h1>
                                <p style="color: #666;">View and manage your active job listings.</p>
                            </div>

                            <div v-if="myJobs.length === 0" class="empty-state">
                                <div class="empty-icon">ðŸ“‚</div>
                                <h3>No Jobs Posted</h3>
                                <p>You haven't posted any jobs yet. Go to the "Post a Job" tab to get started.</p>
                                <button class="btn btn-primary" @click="activeTab = 'post'">Post First Job</button>
                            </div>

                            <div v-else class="job-manage-list">
                                <div class="job-manage-item" v-for="job in myJobs" :key="job.id">
                                    <div class="job-manage-info">
                                        <h3><a :href="'job-details.html?id=' + job.id">[[ job.title ]]</a></h3>
                                        <p>[[ job.location ]] â€¢ [[ job.type ]]</p>
                                        <span class="text-muted" style="font-size: 0.8rem;">ID: [[ job.id ]]</span>
                                    </div>
                                    <div class="job-manage-actions">
                                        <button class="btn btn-card-details" @click="viewJob(job.id)">View</button>
                                        <button class="btn btn-card-details" style="border-color: #f59e0b; color: #d97706;" @click="editJob(job)">Edit</button>
                                        <button class="btn btn-remove-job" @click="confirmDeleteJob(job.id)">Delete</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="activeTab === 'applications'" key="applications">
                        <div class="content-card">
                            <div class="dashboard-header">
                                <h1>Applications</h1>
                                <p style="color: #666;">Review candidates who applied to your jobs.</p>
                            </div>

                            <div v-if="applications.length === 0" class="empty-state">
                                <div class="empty-icon">ðŸ“«</div>
                                <h3>No Applications Yet</h3>
                                <p>Once job seekers apply to your jobs, they will appear here.</p>
                            </div>

                            <div v-else class="applications-list">
                                <div class="app-item" v-for="app in applications" :key="app.id">
                                    <div class="app-info">
                                        <h4 style="margin: 0; color: #333;">[[ app.applicantName ]]</h4>
                                        <p style="margin: 5px 0; color: var(--primary-color);">Applied for: <strong>[[ app.jobTitle ]]</strong></p>
                                        <div class="app-meta">
                                            <span class="text-muted">[[ app.date ]]</span>
                                            <a href="#" style="font-size: 0.9rem; margin-left: 10px;">[[ app.cvName ]]</a>
                                        </div>
                                    </div>
                                    <div class="app-actions">
                                        <span v-if="app.status !== 'Pending'" class="status-badge" :class="getStatusClass(app.status)">[[ app.status ]]</span>
                                        <div v-else style="display: flex; gap: 10px;">
                                            <button class="btn btn-card-details" style="padding: 5px 15px; font-size: 0.9rem;" @click="updateAppStatus(app, 'Rejected')">Reject</button>
                                            <button class="btn btn-primary" style="padding: 5px 15px; font-size: 0.9rem;" @click="updateAppStatus(app, 'Accepted')">Accept</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </transition>

            </main>
        </div>
    </div>

    <div v-if="showSuccess" class="toast-notification success">
        <div class="toast-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
        <span>[[ successMessage ]]</span>
    </div>

    <transition name="modal-fade">
        <div class="modal-overlay" v-if="showDeleteModal" @click.self="showDeleteModal = false">
            <div class="modal-card" style="max-width: 400px; padding: 30px; text-align: center;">
                <h3 style="margin-top: 0;">Delete Job?</h3>
                <p>Are you sure you want to delete this job posting? This action cannot be undone.</p>
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                    <button class="btn btn-card-details" @click="showDeleteModal = false" style="flex: 1;">Cancel</button>
                    <button class="btn" @click="deleteJob" style="flex: 1; background-color: #ef4444; color: white; border: none;">Delete</button>
                </div>
            </div>
        </div>
    </transition>

</div>
{% endblock %}

{% block scripts %}
<script>
    (function() {
        const userJson = localStorage.getItem('user');
        if (!userJson) { window.location.href = 'login.html'; return; }
        const user = JSON.parse(userJson);
        if (user.role !== 'provider') {
            alert("Access Denied: Only Job Providers can access the dashboard.");
            window.location.href = 'profile.html';
        }
    })();
</script>
<script src="../static/js/model.js"></script>
<script src="../static/js/dashboard.js"></script>
{% endblock %}